
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sequence Provider &#8212; Spectrum-Pypulseq MRI Console  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=4cc05613" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/sequence_unrolling';</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spectrum Devices" href="spectrum_devices.html" />
    <link rel="prev" title="Acquisition Process" href="acquisition_process.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">Spectrum-Console</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quick_start/index.html">
                        Quick-Start Guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../code_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference/index.html">
                        API Documentation
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/schote/spectrum-console" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitlab1.ptb.de/mri-lab/spectrum-console" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitLab</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../quick_start/index.html">
                        Quick-Start Guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../code_examples/index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_reference/index.html">
                        API Documentation
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/schote/spectrum-console" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://gitlab1.ptb.de/mri-lab/spectrum-console" title="GitLab" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitLab</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="system_setup.html">System Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="acquisition_process.html">Acquisition Process</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Sequence Provider</a></li>
<li class="toctree-l1"><a class="reference internal" href="spectrum_devices.html">Spectrum Devices</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Sequence Provider</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="sequence-provider">
<span id="seq-provider"></span><h1>Sequence Provider<a class="headerlink" href="#sequence-provider" title="Link to this heading">#</a></h1>
<p>For sequence description, the open-source standard pulseq, i.e. the python implementation <a class="reference external" href="https://github.com/imr-framework/pypulseq">PyPulseq</a> is used.
For detailed documentation of this package, see <a class="reference external" href="https://pypulseq.readthedocs.io/en/dev/">PyPulseq documentation</a>.
The sequence provider is build on top of the <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> class from the pypulseq package and adds functionalities to compute the waveforms described by pulseq.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Once the sequence provider has been created, a new pulseq sequence can be loaded by using the build in routine which reads a sequence from <em>.seq</em> file.
Alternatively, a sequence can be set from an existing <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> object.
During the sequence calculation or unrolling process, each block is successively calculated depending on the event types it contains.
The calculated waveforms are stored in a list, where each entry is a <em>numpy</em> array which contains all the waveform definitons of a block.
The waveforms within each array are in column-major (Fortran-style) order.
Within the unrolling process, which is shown in <a class="reference internal" href="#seq-provider-flow"><span class="std std-numref">Fig. 1</span></a>, all the physical values are translated to <code class="docutils literal notranslate"><span class="pre">int16</span></code> values, as explained below.</p>
<figure class="align-center" id="seq-provider-flow">
<a class="reference internal image-reference" href="../_images/sequence_provider.png"><img alt="../_images/sequence_provider.png" src="../_images/sequence_provider.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">Overview flow chart of the sequence unrolling in the sequence provider class.</span><a class="headerlink" href="#seq-provider-flow" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="interfaces">
<h2>Interfaces<a class="headerlink" href="#interfaces" title="Link to this heading">#</a></h2>
<p>To correctly calculate the RF and gradient waveforms, as well as the digital control signals, some additional information are required by the sequence provider.
Some of the required parameters are defined in the device configuration.
Others depend on the experiment and are provided by the user, they are defined in <a class="reference internal" href="../api_reference/acquisition_control.html#acquisition-parameter"><span class="std std-ref">acquisition parameter</span></a>.
A summary of all the required parameters is given below:</p>
<table class="table" id="id1">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">Overview of sequence provider parameters</span><a class="headerlink" href="#id1" title="Link to this table">#</a></caption>
<colgroup>
<col style="width: 10.5%" />
<col style="width: 15.8%" />
<col style="width: 31.6%" />
<col style="width: 42.1%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Scope</p></th>
<th class="head"><p>Parameter</p></th>
<th class="head"><p>Datatype</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Dev</p></td>
<td><p>output_limits</p></td>
<td><p>[float, float, float, float]</p></td>
<td><p>Individual output limits of the 4 analog channels in [mV]</p></td>
</tr>
<tr class="row-odd"><td><p>Dev</p></td>
<td><p>spcm_dwell_time</p></td>
<td><p>float</p></td>
<td><p>Sample rate of the receive card in [s]</p></td>
</tr>
<tr class="row-even"><td><p>Dev</p></td>
<td><p>gradient_efficiency</p></td>
<td><p>[float, float, float]</p></td>
<td><p>Efficiency of the gradient coils x, y and z in [mT/m/A]</p></td>
</tr>
<tr class="row-odd"><td><p>Dev</p></td>
<td><p>gpa_gain</p></td>
<td><p>[float, float, float]</p></td>
<td><p>Gain of the gradient power amplifier in [V/A]</p></td>
</tr>
<tr class="row-even"><td><p>Dev</p></td>
<td><p>rf_to_volt</p></td>
<td><p>float</p></td>
<td><p>Scaling factor of the RF waveform, which translates [Hz] (pypulseq) to [mV]</p></td>
</tr>
<tr class="row-odd"><td><p>Acq</p></td>
<td><p>larmor_freq</p></td>
<td><p>float</p></td>
<td><p>Larmor frequency, frequency of the carrier waveform</p></td>
</tr>
<tr class="row-even"><td><p>Acq</p></td>
<td><p>b1_scaling</p></td>
<td><p>float</p></td>
<td><p>Scaling factor for RF waveform, default is 1.0</p></td>
</tr>
<tr class="row-odd"><td><p>Acq</p></td>
<td><p>fov_scaling</p></td>
<td><p>[float, float, float]</p></td>
<td><p>Scaling factor per gradient channel, default is 1.0</p></td>
</tr>
<tr class="row-even"><td><p>Acq</p></td>
<td><p>grad_offset</p></td>
<td><p>[float, float, float]</p></td>
<td><p>Offset value per gradient channel in [kHz/m], default is 0.0</p></td>
</tr>
</tbody>
</table>
<p>The result is an <a class="reference internal" href="../api_reference/pulseq_interpreter.html#unrolled-sequence"><span class="std std-ref">unrolled sequence</span></a> which contains all the waveforms and some meta data of the calculated sequence.</p>
</section>
<section id="unrolling">
<h2>Unrolling<a class="headerlink" href="#unrolling" title="Link to this heading">#</a></h2>
<p>To unroll a sequence a new zero-filled array is created per block depending on the block duration.
It holds all the waveforms of a block, including RF and the three gradients.
Additionally, three lists of arrays are generated for the three digital signals, namely ADC gate, RF unblanking and phase reference signal.
In the following, we break down the sequence calculation into RF, gradients and digital signals.</p>
<section id="rf-pulses">
<h3>RF Pulses<a class="headerlink" href="#rf-pulses" title="Link to this heading">#</a></h3>
<p>As shown in <a class="reference internal" href="#rf-waveform"><span class="std std-numref">Fig. 2</span></a> an RF event (here a block pulse) is defined by different sections in time, namely delay, deadtime, RF pulse and ringdown time.</p>
<figure class="align-center" id="rf-waveform">
<a class="reference internal image-reference" href="../_images/rf_waveform.png"><img alt="../_images/rf_waveform.png" src="../_images/rf_waveform.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">Example of an RF block pulse which is defined by delay, dead time, RF pulse and ring-down time.</span><a class="headerlink" href="#rf-waveform" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>In a first step, each section is converted into the respective number of sampling points on the replay time grid, defined by <span class="math notranslate nohighlight">\(f_{spcm}\)</span>.
The RF waveform is first scaled to <em>int16</em> using <span class="math notranslate nohighlight">\(b_1\)</span> scaling, <em>rf_to_mvolt</em> and <em>max_output</em> of channel 0.
Using the calculated number of RF pulse sample points, the envelope is resampled.</p>
<p>Depending on the number of RF pulse sample points the time slope is generated to calculate the carrier signal.
The modulated RF signal <span class="math notranslate nohighlight">\(s(t)\)</span> is calculated by</p>
<div class="math notranslate nohighlight">
\[s(t) = A(t) e^{2 \pi i (f_0 + \Delta f) t + \Delta \varphi},\]</div>
<p>where <span class="math notranslate nohighlight">\(A(t)\)</span> is the resampled envelope, <span class="math notranslate nohighlight">\(f_0\)</span> is the Larmor frequency, <span class="math notranslate nohighlight">\(\Delta f\)</span> is the frequency offset, <span class="math notranslate nohighlight">\(t\)</span> is the time course and <span class="math notranslate nohighlight">\(\Delta \varphi\)</span> is the phase offset.
The complex-valued RF signal is inserted into the predefined zero-filled array.
The position in the array is determined by the number of sample points calculated from the time sections as shown in <a class="reference internal" href="#rf-waveform"><span class="std std-numref">Fig. 2</span></a>.</p>
<p>Since the RF unblanking signal also depends on the RF pulse timing parameters, it is set in the same function calculating the RF waveform.
Note that per definition in PyPulseq, a delay always contains the RF dead time.
Thus the starting point of the RF unblanking signal in the array is defined by delay - RF dead time.</p>
</section>
<section id="gradients">
<h3>Gradients<a class="headerlink" href="#gradients" title="Link to this heading">#</a></h3>
<p>The RF and gradient waveforms are replayed by the same transmit card and thus need to be defined on the same time grid defined by <span class="math notranslate nohighlight">\(f_{spcm}\)</span>.
A gradient event can either be defined as a trapezoid or as an arbitrary gradient.
<a class="reference internal" href="#trap-gradient"><span class="std std-numref">Fig. 3</span></a> shows the definition of a trapezoid gradient and its translation to the sampled waveform.</p>
<figure class="align-center" id="trap-gradient">
<a class="reference internal image-reference" href="../_images/trapezoid_gradient_waveform.png"><img alt="../_images/trapezoid_gradient_waveform.png" src="../_images/trapezoid_gradient_waveform.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">Definition and conversion of a trapezoidal gradient waveform.</span><a class="headerlink" href="#trap-gradient" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>A trapezoidal gradient is usually defined by delay, rise time, flat time, fall time and amplitude.
As for an RF event, the time segments of a trapezoidal gradient are first converted into the corresponding numbers of sampling points.
Correct scaling of the gradient waveform is achieved by the following steps:</p>
<ol class="arabic simple">
<li><p>Conversion <span class="math notranslate nohighlight">\(\frac{kHz}{T} \rightarrow mV\)</span> defined by the relation
<span class="math notranslate nohighlight">\(s(t) [mV] = \frac{s(t) [\frac{kHz}{T}] \cdot 10^{-3}}{\gamma [\frac{MHz}{T}] \cdot \text{gain} [\frac{A}{V}] \cdot \text{eff} [\frac{\frac{mT}{m}}{A}]}\)</span>
, where <span class="math notranslate nohighlight">\(s(t)\)</span> is the gradient waveform, <span class="math notranslate nohighlight">\(\gamma\)</span> is the gyromagnetic ratio, <span class="math notranslate nohighlight">\(\text{gain}\)</span> is the GPA gain and <span class="math notranslate nohighlight">\(\text{eff}\)</span> is the gradient coil efficiency.
This conversion is defined by the hardware parameters in the device configuration.</p></li>
<li><p>Field of view scaling and offset: <span class="math notranslate nohighlight">\(s(t) [mV] = s(t) [mV] * \text{fov}_{channel} + \text{offset}_{channel}\)</span>. Both parameters are defined in the acquisition parameter.</p></li>
<li><p>Conversion from <span class="math notranslate nohighlight">\([mV]\)</span> to <em>int16</em> using the maximum output of the specific channel, as defined in the device configuration.</p></li>
</ol>
<p>Using the scaled amplitude, and the calculated number of sample points for the time sections, the gradient waveform sections are calculated.
The final waveform is obtained by concatenating all the sections.</p>
<p><a class="reference internal" href="#arbitrary-gradient"><span class="std std-numref">Fig. 4</span></a> shows an arbitrary gradient event which is defined similar to an RF event.</p>
<figure class="align-center" id="arbitrary-gradient">
<a class="reference internal image-reference" href="../_images/arbitrary_gradient_waveform.png"><img alt="../_images/arbitrary_gradient_waveform.png" src="../_images/arbitrary_gradient_waveform.png" style="width: 90%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Definition and conversion of an arbitrary gradient waveform.</span><a class="headerlink" href="#arbitrary-gradient" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>In case of an arbitrary gradient, the course time grid and the corresponding amplitudes are stored with the gradient.
Thus, an arbitrary gradient only has two time sections, namely delay and the waveform.
Gradient scaling is performed before resampling the waveform, as described above.</p>
<p>The final waveform, independent of the gradient type, is inserted into the waveform array.
Again the position in the array is determined by the number of delay samples.</p>
</section>
<section id="digital-signals">
<h3>Digital Signals<a class="headerlink" href="#digital-signals" title="Link to this heading">#</a></h3>
<p>Next to the waveform data, there are 3 digital signals which are calculated with a sequence:</p>
<ul class="simple">
<li><p>RF unblanking signal to enable the RF power amplifier</p></li>
<li><p>ADC gate signal to control sampling of the receive card</p></li>
<li><p>Reference signal to correct for phase jumps caused by the measurement cards</p></li>
</ul>
<p>The RF unblanking signal is generated along with an RF event as described above.
The ADC signal instead is described by an independent event.
Dependent on the delay of an ADC event, the position in the array is determined as described above and the gate signal is set according to the ADC duration.
During an active gate signal, also the reference signal is transferred.
For simplicity, the reference signal is calculated with the Larmor frequency using <span class="math notranslate nohighlight">\(ref(t) = e^{2 \pi i f_0 t}\)</span>.
Its discrete representation is obtained by setting the digital signal whenever the reference signal is positive.
Note that a phase offset is not necessary, as the same clock is used on both, transmit and receive card.</p>
<p>To replay the digital signals synchronously with the analog signals, they are encoded using the 16th bit of each of the gradient waveforms.
This reduces the resolution by 1 bit, thus we decided to use the gradient channels to encode the signals and keep up the resolution of the RF channel.
Analog and digital signals are combined by the following expression:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">analog</span> <span class="o">=</span> <span class="n">analog</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">digital</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<p>The analog signal can be viewed as an unsigned integer even though it is a signed, because it is shifted.
Viewing the values as unsigned integers prevents errors of the sign caused by python.
The digital integer value (0 or 1) is shifted to the 16th bit position and combined with the analog signal by logical OR operation.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="acquisition_process.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Acquisition Process</p>
      </div>
    </a>
    <a class="right-next"
       href="spectrum_devices.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Spectrum Devices</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">

  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interfaces">Interfaces</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unrolling">Unrolling</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rf-pulses">RF Pulses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gradients">Gradients</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#digital-signals">Digital Signals</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/sequence_unrolling.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, Physikalisch-Technische Bundesanstalt (PTB) Berlin.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>